<html>
<head>
	<title>nes</title>
	<link rel="stylesheet" href="http://www.hmphry.com/barebones/css/barebones.css">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/3.0.0/knockout-min.js"></script>
	<script src="./nes/constants.js"></script>
	<script src="./nes/system.js"></script>
	<script src="./nes/cpu.js"></script>
	<script src="./nes/ppu.js"></script>
	<script src="./nes/cartridge.js"></script>
	<script src="./nes/mapper.js"></script>
</head>

<body>

<input type="file" data-bind="event: { change: ChooseROM }">
<!--<canvas id="c" width="256" height="256"></canvas>-->

<hr>

<div class="container" style="font-family: monospace">

	<div class="column twelve">
		<button data-bind="click: Step">step</button>
		<button data-bind="click: Run">run</button>
		<span>breakpoint:</span>
		<input type="text" data-bind="value: Breakpoint">
	</div>

	<div class="column three">
		<table data-bind="foreach: Disassembly">
			<tbody>
			<!-- ko if: typeof PC !== "undefined" -->
			<tr>
				<td data-bind="text: '$' + ('0000' + PC.toString(16)).substr(-4, 4)" style="color: lightgray"></td>
				<td data-bind="text: Text"></td>
			</tr>
			<!-- /ko -->
			</tbody>
		</table>
	</div>

	<div class="column one">
		<!-- ko if: typeof CPUDetails() !== "undefined" -->
		<table>
		<tr><td>PC</td><td data-bind="text: '$' + ('0000' + CPUDetails().PC.toString(16)).substr(-4, 4)"></td></tr>
		<tr><td>A</td><td data-bind="text: '$' + ('00' + CPUDetails().A.toString(16)).substr(-2, 2)"></td></tr>
		<tr><td>X</td><td data-bind="text: '$' + ('00' + CPUDetails().X.toString(16)).substr(-2, 2)"></td></tr>
		<tr><td>Y</td><td data-bind="text: '$' + ('00' + CPUDetails().Y.toString(16)).substr(-2, 2)"></td></tr>
		<tr><td>S</td><td data-bind="text: '$' + ('00' + CPUDetails().S.toString(16)).substr(-2, 2)"></td></tr>
		</table>
		<!-- /ko -->
	</div>

	<div class="column eight">
		<span>memory offset:</span>
		<input type="text" data-bind="value: MemoryOffset">
		<br>
		<!-- ko if: typeof Memory() !== "undefined" -->
		<table data-bind="foreach: Memory">
			<tbody>
			<tr>
				<td data-bind="text: '$' + ('0000' + (parseInt($root.MemoryOffset(), 16) + 0x10 * $index()).toString(16)).substr(-4, 4)" style="color: lightgray"></td>
				<td data-bind="foreach: $data">
					<span data-bind="text: '$' + ('00' + $data.toString(16)).substr(-2, 2)"></span>
				</td>
		</table>
		<!-- /ko -->
	</div>

</div>

<script type="text/javascript">
function DebuggerModel()
{
	var Self = this;
	var System = ko.observable();
	Self.CPUDetails = ko.observable();
	Self.MemoryOffset = ko.observable();
	Self.Breakpoint = ko.observable();

	Self.ChooseROM = function(Data, E)
	{
		var FR = new FileReader();

		FR.addEventListener
		(
			"load",
			function()
			{
				if (FR.error) return console.log("error reading the ROM", FR.error);
				System(new NES.System());
				System().LoadCartridge(new Uint8Array(FR.result));
				Self.CPUDetails(System().CPUDetails());
				Self.MemoryOffset("0000");
			}
		);

		FR.readAsArrayBuffer(E.target.files[0]);
	};

	Self.Disassembly = ko.computed
	(
		function()
		{
			Self.CPUDetails();
			if (!System()) return;
			return System().Disassemble();
		}
	);

	Self.Step = function()
	{
		System().Step();
		Self.CPUDetails(System().CPUDetails());
	};

	Self.Run = function()
	{
		var Breakpoint = parseInt(Self.Breakpoint(), 16);
		while (true)
		{
			var NewPC = System().Step();
			if (NewPC == Breakpoint) break;
		}

		Self.CPUDetails(System().CPUDetails());
	}

	Self.Memory = ko.computed
	(
		function()
		{
			Self.CPUDetails();
			if (!System()) return;
			var RowLength = 0x10;
			var Offset = parseInt(Self.MemoryOffset(), 16);
			var Dump = System().MemoryDump(Offset, 8 * RowLength);
			var Memory = [];
			while (Dump.length > 0)
				Memory.push(Dump.splice(0, RowLength));

			return Memory;
		}
	);
}

ko.applyBindings(new DebuggerModel());
</script>
</body>
</html>
